{% extends 'base.html' %}

{% block content %}
<br>
<h1 style="text-align:center;"><img style="filter: invert(100%)" width="100" src="/static/logo.png" />{% block title %}Ext Exposed{% endblock %}</h1>
<div class="container">
  <div class="center">
    <form action="/scan" id="scanForm" method="POST">
      <div class="form-group text-center">
        <label for="search">Submit a chrome extension to scan</label>
        <input type="text" class="form-control" id="scan" name="keyword" placeholder="Chrome extension url or ID">
      </div>

      <div class="form-group text-center text-dark">
        <button type="button" id="submit" class="btn btn-primary">Submit</button>
      </div>
      <div class="card form-group advanced-search-panel ">
        <div class="card-header bg-primary">
          Scan Options
        </div>
        <div class="panel panel-default">
          <ul class="list-group">
            <!-- add options here -->
            <li class="list-group-item">
              <div class="form-group">


                <div class="col-xs-8">
                  <div class="row">
                    <fieldset class="col-xs-12 col-sm-6">
                      <input type="checkbox" name="static" autocomplete="off" checked>
                      Static Analysis
                    </fieldset>
                    <fieldset class="col-xs-12 col-sm-6">
                      <input type="checkbox" name="sandbox" autocomplete="off" checked>
                      Dynamic Analysis (sandbox)
                    </fieldset>
                    <fieldset class="col-xs-12 col-sm-6">
                      <input type="checkbox" name="domains" autocomplete="off" disabled>
                      Yara Rules (comming soon)
                    </fieldset>
                    <fieldset class="col-xs-12 col-sm-6">
                      <input id="sandbox_range" name="time_limit" class="slider form-control" type="range" min="5" max="600" value="20">
                      <br>
                      Duration (seconds): <span id="range_text" />
                    </fieldset>
                  </div>
                </div>
              </div>

              <div class="clearfix"></div>
            </li>

            <li class="list-group-item">
              <div class="form-group">
                <div class="col-xs-4">
                  <label for="search-location">Yara Signatures</label>
                </div>

                <div class="col-xs-8">
                  <div class="row">
                    <fieldset class="col-xs-12 col-sm-6">
                      <input type="checkbox" name="lnkr value=" enabled" autocomplete="off" checked>
                      Lnkr
                    </fieldset>

                  </div>
                </div>
              </div>

              <div class="clearfix"></div>
            </li>
            <!-- end of options -->
          </ul>

        </div>
      </div>
    </form>
    <div class="modal fade" id="myModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Scan in progress</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Static Analysis progress</p>
            <div class="progress">
              <div id="static_bar", class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
            </div>
            <p>Dynamic Analysis progress</p>
            <div class="progress">
              <div id="dynamic_bar", class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
            </div>
            <p id=output>test</p>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
  var slider = document.getElementById("sandbox_range");
  var output = document.getElementById("range_text");
  output.innerHTML = slider.value;

  slider.oninput = function() {
    output.innerHTML = this.value;
  }
</script>
<script type=text/javascript> $SCRIPT_ROOT={{ request.script_root|tojson|safe }}; </script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
    $("#submit").on('click', function() {

      $.ajax({
        url: $SCRIPT_ROOT + "/scan",
        data: $("#scanForm").serialize(),
        method: "POST",
        dataType: "json",
        success: function(data, status, request) {
          if(data['static'] != ""){
            check_job_status($SCRIPT_ROOT+"/status/"+data['static'],'static_0')
          }
            $('#myModal').modal('show')
        },
        error: function(jqXHR, textStatus, errorThrown) {
          alert(jqXHR.responseText)
        }
      });
    });

    function check_job_status(status_url, pbar) {
    $.getJSON(status_url, function(data) {
    $('#output').text(data.status).show();

    console.log(data);
    switch (data.status) {
      case "unknown":
          alert("Unknown job id");
          //$("#submit").removeAttr("disabled");
          break;
      case "finished":
          //flash_alert(data.result, "success");
          //$("#submit").removeAttr("disabled");
          break;
      case "failed":
        //  flash_alert("Job failed: " + data.message, "danger");
          //$("#submit").removeAttr("disabled");
          break;
      default:
        // queued/started/deferred
        setTimeout(function() {
          check_job_status(status_url);
        }, 500);
    }
  });
}

  </script>

{% endblock %}
